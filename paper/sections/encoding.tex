\section{Instantiation} \label{sec:encoding}
In this section we instantiate Numerical Fuzz to provide \textit{a priori} and
\textit{a posterori} error bounds in the presence of subtraction and negative
numbers.
In Section~\ref{sec:instantiation}, we instantiate Numerical Fuzz using the
modular interface defined in Definition~\ref{def:numfuzz-interface} using a
$\textit{paired representation}$ introduced below. Then, in
Section~\ref{sec:application} we demonstrate how to read out the
$\textit{paired-representation}$ as concrete bounds for standard, unpaired,
floating-point arithmetic.

\subsection{Instantiation} \label{sec:instantiation}
Our forwards error analysis relies on bounding Lipschitz function sensitivity.
However, subtraction, and by extension addition with negative numbers, has
unbounded Lipschitz sensitivity over the reals. This poses a challenge to a
compositional type-based analysis of programs involving subtraction and negative
numbers.

To avoid this problem, we encode our semantics through a \textit{paired
representation} where we associate for each real $r \in \mathbb{R}$ a class of
triples
$(r, a, b) \in \mathbb{P} = \mathbb{R} \times \mathbb{R}^+ \times \mathbb{R}^+ = \mathit{num}$ 
such that $r = a - b$. To soundly use our encoding, we must show it satisfies
the correctness properties demanded by the modular interface defined in
Section~\ref{sec:lang}.

\begin{lemma}[$\mathbb{P}$ forms a metric space.]
\end{lemma}
\begin{proof}
Symmetry and reflexivity hold trivially. Triangle inequality holds from triangle
inequality on $d_{\mathbb{R}}$.
\end{proof}

% To avoid this problem, we encode our semantics through a \textit{paired
% representation} where we associate for each real $r \in \mathbb{R}$ a pair $(a,
% b) \in \mathbb{R}^2$ such that $r = a - b$. 
Our operations and interval bounds operate over the paired representation
$\mathbb{P}$. In this manner, subtraction and negative numbers can be encoded
using bounded-sensitivity operations over the non-negative reals, avoiding the
problem of infinite sensitivity.
We instantiate the modular interface with the interval operations 
$\Sigma_\textbf{num} = \{+, -, \cdot \}$, defined as follows:
\begin{equation}
  \begin{aligned}[c]
    ((r_l, a_l, b_l),(r_h, a_h, b_h)) + 
      ((r'_l, a'_l, b'_l),(r'_h, a'_h, b'_h)) &=
      ((r_l + r'_l, a_l + a'_l, b_l + b'_l), (r_h + r'_h, a_h + a'_h, b_h + b'_h)) \\
    ((r_l, a_l, b_l),(r_h, a_h, b_h)) - 
      ((r'_l, a'_l, b'_l),(r'_h, a'_h, b'_h)) &=
    ((r_{min}^{sub} - r'_h, a_l + b'_l, b_l + a'_l), (r_{max}^{sub} - r'_l, a_h + b'_h, b_h + a'_h)) \\
    ((r_l, a_l, b_l),(r_h, a_h, b_h)) \cdot
      ((r'_l, a'_l, b'_l),(r'_h, a'_h, b'_h)) &=
    ((r_{min}^{mul}, a_l a'_l + b_l b'_l, a_l b'_l + b_l a'_l), \\ 
    & \quad \quad (r_{max}^{mul}, a_h a'_h + b_h b'_h, a_h b'_h + b_h a'_h)) \\
  \end{aligned}
\end{equation}
where $r_{min}^{sub} = min(\{x - y \ | \ \forall x \in [r_l, r_h] \ \forall y \in [r'_l, r'_h]\})$
and $r_{max}^{sub} = max(\{x - y \ | \ \forall x \in [r_l, r_h] \ \forall y \in [r'_l, r'_h]\})$
and $r_{min}^{mul} = min(\{x \cdot y \ | \ \forall x \in [r_l, r_h] \ \forall y \in [r'_l, r'_h]\})$
and $r_{max}^{mul} = max(\{x \cdot y \ | \ \forall x \in [r_l, r_h] \ \forall y \in [r'_l, r'_h]\})$
and term-level operations 
$\Sigma = \{ \textbf{add}, \ \textbf{add}, \ \textbf{mul} \}$
are given as follows:
\begin{equation}
\begin{aligned}[c]
  &\textbf{add} : \forall \epsilon_1, \epsilon_2, \mathbf{num}_{\epsilon_1} \times
  \mathbf{num}_{\epsilon_2} \multimap \mathbf{num}_{\epsilon_1 + \epsilon_2} \\
  &\textbf{add} \ \bnd{\{\epsilon_1\}} \ \bnd{\{\epsilon_2\}} \ (\langle (r, a,
  b), (r', a', b') \rangle) \mapsto (r + r', a + a', b + b') \\
  \\
  &\textbf{sub} : \forall \epsilon_1, \epsilon_2, \mathbf{num}_{\epsilon_1} \times
  \mathbf{num}_{\epsilon_2} \multimap \mathbf{num}_{\epsilon_1 - \epsilon_2} \\
  &\textbf{sub} \ \bnd{\{\epsilon_1\}} \ \bnd{\{\epsilon_2\}} \ (\langle (r, a, b),
  (r, a', b') \rangle ) \mapsto (r - r', a + b', b + a') \\
  \\
  &\textbf{mul} : \forall \epsilon_1, \epsilon_2, \mathbf{num}_{\epsilon_1} \times
  \mathbf{num}_{\epsilon_2} \multimap \mathbf{num}_{\epsilon_1 \cdot \epsilon_2} \\
  &\textbf{mul} \ \bnd{\{\epsilon_1\}} \ \bnd{\{\epsilon_2\}} \ (((r, a, b), (r, a',
  b'))) \mapsto (r * r', a * b + b * b', b * a' + a * b') \\
\end{aligned}
\end{equation}

Given a rounding function $\rho_\mathbb{R}$ over the reals, we can also
associate a paired $\rho_{\mathbb{P}}$, defined below:
\begin{definition}[Rounding over pairs]
$\rho_{\mathbb{P}}((r, a, b)) = 
\begin{cases}
  (0, a, b)  & r = 0\\
(\rho_{\mathbb{R}}(r), a \cdot \frac{\rho_{\mathbb{R}}(r)}{r}  b \cdot
  \frac{\rho_{\mathbb{R}}(r)}{r}), & r \not=0 \\
\end{cases}
$.
\end{definition}
It is sound to use the same round-off error bound $u$ associated with $\rho_\mathbb{R}$ for $\rho_\mathbb{P}$.
In other words, we wish to show that the translated rounding function can share
the same unit round-off constant as the original rounding function over the
unpaired representation:
\begin{lemma}[Property of rounding and constant parameter $u$]
We wish to show that given a unit round-off bound $u$ and $\rho_{\mathbb{R}}$ such that 
    $\forall e \in d_\mathbb{R} (\rho(e), e) \leq u$, then
    $\forall e \in \mathcal{R}_{num}, \mathcal{SD}_{\mathbf{num}}(\rho_{\mathbb{P}}(e), e)
    \leq u$. 
\end{lemma}
\begin{proof}
$(\rho_{\mathbb{P}}((r, a, b)), (r, a, b)) = 
(\rho_{\mathbb{R}}(r), a
\cdot \frac{\rho_{\mathbb{R}}(r)}{r}, b \cdot \frac{\rho_{\mathbb{R}}(r)}{r})$. 
So, 
$
d_{\mathbb{P}}((\rho_{\mathbb{R}}(r), a
\cdot \frac{\rho_{\mathbb{R}}(r)}{r}, b \cdot \frac{\rho_{\mathbb{R}}(r)}{r}), (r, a, b)) = max(\rho_{\mathbb{R}}(r), \rho_{\mathbb{R}}(r)) = \rho_{\mathbb{R}} (r)
$.
\end{proof}

Our operations satisfy metric preservation.
% todo: these are closed over something other than num?

\begin{lemma}[Operations satisfy metric preservation]
Each $\textbf{op} : \tau \in \Sigma$ satisfies metric preservation.
\end{lemma}
\begin{proof}
Holds by unfolding.
\end{proof}


Moreover, our interval operations are closed over intervals ($\mathbb{P}^2$).
\begin{lemma}[Interval operations closure.]
Each interval operation is closed over our intervals $\mathbb{P}^2$.
\end{lemma}
\begin{proof}
Holds by inspection.
\end{proof}

By stapling together the proceeding lemmas, the interface ($\mathbb{P}, d_{\mathbb{P}}, \rho_{\mathbb{P}}, u, \Sigma, \Sigma_{\mathbf{num}}$) satisfy the interface for instantiating Numerical Fuzz specified in Definition~\ref{def:numfuzz-interface}.

\subsection{Application} \label{sec:application}
For a given $. \vdash e : M_q \textbf{num}_{(k_0, k_1)}$, we wish to bound the
error between $e$ computed ideally over the reals versus the floating-point
approximation. We now prove our paired error theorems
(Theorem~\ref{thm:paired-a-priori-rel}, Theorem~\ref{thm:paired-a-posteriori-rel}, ),
which for a triple $(r, a, b)$ relates error on the paired components $a, b$
with error on $r$. By plugging in the theorems proved below, we are able to
obtain multiple bounds for a given typed program.

% Note that we have the condition $0 < r^{\downarrow}$. This can be generalized
% to $r^{\downarrow}$ and $r^{\uparrow}$ having the same sign.
\begin{theorem}[Paired error theorem; a priori relative] \label{thm:paired-a-priori-rel}
  For any numbers $((r, a, b), (r', a', b')) \in \mathbb{P}^2$ and where we have
  $a^{\downarrow}, a^{\uparrow}, b^{\downarrow}, b^{\uparrow} \in \mathbb{R}^{+}$:
  the following bounds for $r^{\downarrow}, r^{\uparrow} \in \mathbb{R}$, 
  \begin{enumerate}
    \item $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$
    \item $r \in [r^{\downarrow}, r^{\uparrow}]$ and $0 < r^{\downarrow}$
    \item $a \in [a^{\downarrow}, a^{\uparrow}]$
    \item $b \in [b^{\downarrow}, b^{\uparrow}]$
  \end{enumerate}
  we have that $d_{\mathbb{R}}(r, r')$ is less than or equal to all of the
  following bounds: 
\begin{enumerate}
  \item $max(|ln(e^q + \frac{a^{\uparrow}}{r^{\downarrow}}(e^{-q} - e^q))|, |ln(e^{-q} + \frac{a^{\downarrow}}{r^{\uparrow}}(e^{q} - e^{-q}))|)$
  \item $max(|ln(e^q + \frac{b^{\uparrow}}{r^{\downarrow}}(e^q - e^{-q}))|,|ln(e^q + \frac{b^{\downarrow}}{r^{\uparrow}}(e^{-q} - e^{q}))|)$
\end{enumerate} 
\end{theorem}
\begin{proof}
  Our error metric is symmetric so for this theorem we wish to prove a bound on
  $d_{\mathbb{R}}(r', r)$. We prove each bound and, for each bound, split into
  two cases: $r \leq r'$ or $r > r'$. In the first case, we have:
  \begin{equation}
  \begin{aligned}[c]
  1 \leq 
  \frac{r'}{r} \leq
  \frac{a' - be^q}{a - b} =
  \frac{a' - be^q + ae^q - ae^q}{a - b} \\ =
  e^q + \frac{a' - ae^q}{a - b} \leq
  e^q + \frac{ae^{-q} - ae^q}{a - b} =
  e^q + \frac{a}{a - b}(e^{-q} - e^q) \\ \leq
  e^q + \frac{a^{\uparrow}}{r^{\downarrow}}(e^{-q} - e^q) 
  \end{aligned}
  \end{equation}
  Therefore, 
  \begin{equation} \label{eq:a-priori-bnd-a-pos}
  \begin{aligned}[c]
  0 \leq ln(\frac{r'}{r}) \leq 
  ln(e^q + \frac{a^{\uparrow}}{r^{\downarrow}}(e^{-q} - e^q))
  \end{aligned}
  \end{equation}
  In the second case, we have:
  \begin{equation}
  \begin{aligned}[c]
    1 \geq
    \frac{r'}{r} \geq
    \frac{a' - be^{-q}}{a - b} = 
    \frac{a' - be^{-q} + ae^{-q} - ae^{-q}}{a - b} \\ =
    e^{-q} + \frac{a' - ae^{-q}}{a - b} \geq
    e^{-q} + \frac{ae^{q} - ae^{-q}}{a - b} = 
    e^{-q} + \frac{a}{a-b}(e^{q} - e^{-q}) \\ \geq
    e^{-q} + \frac{a^{\downarrow}}{r^{\uparrow}}(e^{q} - e^{-q})
  \end{aligned}
  \end{equation}
  Therefore, 
  \begin{equation} \label{eq:a-priori-bnd-a-neg}
  \begin{aligned}[c]
    0 \geq ln(\frac{r'}{r}) \geq
    ln(e^{-q} + \frac{a^{\downarrow}}{r^{\uparrow}}(e^{q} - e^{-q}))
  \end{aligned}
  \end{equation}

  A sound bound for both cases is the maximum of the absolute value of
  Equation~\ref{eq:a-priori-bnd-a-pos} and Equation~\ref{eq:a-priori-bnd-a-neg},
  which is exactly our first bound (1). The proof strategy for the second bound
  (2) mirrors that of the first bound.
\end{proof}

\begin{corollary}
  For $. \vdash e : M_q~\mathbf{num}_{(k_0, k_1)}$, $e \mapsto ((r, a, b), (r',
  a', b'))$ where $d_{\mathbb{R}}(r, r')$ is less than or equal to all of the
  following bounds: 
\begin{enumerate}
  \item $max(|ln(e^q + \frac{a^{\uparrow}}{r^{\downarrow}}(e^{-q} - e^q))|, |ln(e^{-q} + \frac{a^{\downarrow}}{r^{\uparrow}}(e^{q} - e^{-q}))|)$
  \item $max(|ln(e^q + \frac{b^{\uparrow}}{r^{\downarrow}}(e^q - e^{-q}))|,|ln(e^q + \frac{b^{\downarrow}}{r^{\uparrow}}(e^{-q} - e^{q}))|)$
\end{enumerate} 
\end{corollary} 
\begin{proof}
  By our logical relation and metric preservation theorem (Theorem
  \ref{thm:metric-preservation}), we know that $e \mapsto ((r, a, b), (r', a',
  b'))$ such that $d_{\mathbb{P}}((r, a, b), (r', a', b')) \leq q$. Therefore,
  $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$. Applying the previous
  theorem proves the corollary.
\end{proof}

\begin{theorem}[Paired error theorem; a posteriori relative] \label{thm:paired-a-posteriori-rel}
  For any numbers $((r, a, b), (r', a', b')) \in \mathbb{P}^2$ and where we have
  $a^{\downarrow}, a^{\uparrow}, b^{\downarrow}, b^{\uparrow} \in \mathbb{R}^{+}$:
  the following bounds for $r^{\downarrow}, r^{\uparrow} \in \mathbb{R}$, 
  \begin{enumerate}
    \item $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$
    \item $r \in [r^{\downarrow}, r^{\uparrow}]$
    \item $a \in [a^{\downarrow}, a^{\uparrow}]$
    \item $b \in [b^{\downarrow}, b^{\uparrow}]$
  \end{enumerate}
  and we know $r'$, we have that $d_{\mathbb{R}}(r, r')$ is less than or equal
  to all of the following bounds: 
\begin{enumerate}
  \item $max(|ln(e^q + \frac{a}{r'}(1-e^{2q}))|,|ln(e^{-q} + \frac{a}{r'}(1-e^{-2q}))|)$
  \item $max(|ln(e^{-q} + \frac{b}{r'}(e^{-2q}- 1))|,|ln(e^q + \frac{b}{r'}(e^{2q}-1))|)$
\end{enumerate}
\end{theorem} 
\begin{proof}
  Similarly to the previous theorem, there are two cases, $r \leq r'$ or $r >
  r'$. In the first case, we wish to minimize $a-b$ and maximize $a' - b'$. So, 
  \begin{equation} \label{eq:a-posterori-bnd-a-pos}
  \begin{aligned}[c]
    |ln(\frac{r}{r'})| \leq 
    |ln(\frac{a - b'e^q}{a' - b'})| =
    |ln(\frac{a - b' e^q + a'e^q - a'e^q}{a' - b'})| \\ =
    |ln(e^q + \frac{a - a'e^q}{a' - b'})| \leq
    |ln(e^q + \frac{a - ae^{2q}}{a' - b'})| =
    |ln(e^q + \frac{a}{r'}(1-e^{2q}))|
  \end{aligned}
  \end{equation}
  Similarly, for the other case, we have:
  \begin{equation} \label{eq:a-posterori-bnd-a-neg}
  \begin{aligned}[c]
    |ln(\frac{r}{r'})| \leq 
    |ln(\frac{a - b'e^{-q}}{a' - b'})| =
    |ln(\frac{a - b'e^{-q} + a'e^{-q} - a'e^{-q}}{a' - b'})| \\ =
    |ln(e^{-q} + \frac{a - a'e^{-q}}{a' - b'})| \leq
    |ln(e^{-q} + \frac{a - ae^{-2q}}{a' - b'})| =
    |ln(e^{-q} + \frac{a}{r'}(1-e^{-2q}))|
  \end{aligned}[c]
  \end{equation}
  A sound bound for both cases is the maximum of
  Equation~\ref{eq:a-posterori-bnd-a-pos} and Equation~\ref{eq:a-posterori-bnd-a-neg},
  which is exactly our first bound (1). The proof strategy for the second bound
  (2) mirrors that of the first bound.
\end{proof}

\begin{corollary}
  For $. \vdash e : M_q~\mathbf{num}_{(k_0, k_1)}$, $e \mapsto^{*} ((r, a, b),
  (r', a', b'))$ where $d_{\mathbb{R}}(r, r')$ is less than or equal to all of
  the following bounds: 
\begin{enumerate}
  \item $max(|ln(e^q + \frac{a}{r'}(1-e^{2q}))|,|ln(e^{-q} + \frac{a}{r'}(1-e^{-2q}))|)$
  \item $max(|ln(e^{-q} + \frac{b}{r'}(e^{-2q}- 1))|,|ln(e^q + \frac{b}{r'}(e^{2q}-1))|)$
\end{enumerate}
\end{corollary} 
\begin{proof}
  By our logical relation and metric preservation theorem (Theorem
  \ref{thm:metric-preservation}), we know that $e \mapsto ((r, a, b), (r', a',
  b'))$ such that $d_{\mathbb{P}}((r, a, b), (r', a', b')) \leq q$. Therefore,
  $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$. Applying the previous
  theorem proves the corollary.
\end{proof}

\begin{theorem}[Paired error theorem; a priori absolute] \label{thm:paired-a-priori-abs}
  For any numbers $((r, a, b), (r', a', b')) \in \mathbb{P}^2$ and where we have
  the following bounds for $r^{\downarrow}, r^{\uparrow} \in \mathbb{R}$, 
  $a^{\downarrow}, a^{\uparrow}, b^{\downarrow}, b^{\uparrow} \in \mathbb{R}^{+}$:
  \begin{enumerate}
    \item $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$
    \item $r \in [r^{\downarrow}, r^{\uparrow}]$
    \item $a \in [a^{\downarrow}, a^{\uparrow}]$
    \item $b \in [b^{\downarrow}, b^{\uparrow}]$
  \end{enumerate}
  we have that $|r - r'|$ is the maximum of the following:
\begin{enumerate}
  \item $a^{\uparrow}(1-e^{-q}) - b^{\downarrow}(1 - e^q)$
  \item $a^{\downarrow}(1-e^{-q}) - b^{\uparrow}(1 - e^q)$
  \item $a^{\uparrow}(e^{q}-1) - b^{\downarrow}(e^{-q} - 1)$
  \item $a^{\downarrow}(e^{q}-1) - b^{\uparrow}(e^{-q} - 1)$
\end{enumerate} 
\end{theorem} 
\begin{proof}
  We case into whether $r \geq r'$ (or not) and $r \geq 0$ (or not). This
  produces four cases:
  \begin{description}
    \item [Case $r \geq r'$ and $r \geq 0$.] We have that:
      \begin{equation}
        \begin{aligned}
          (a - b) - (a' - b') &\leq (a - b) - (ae^{-q} - be^{q}) \\
                              &\leq a^{\uparrow} - b^{\downarrow} - (a^{\uparrow}e^{-q} - a^{\downarrow}e^{q}) \\
                              &= a^{\uparrow}(1-e^{-q}) - b^{\downarrow}(1 - e^q)
        \end{aligned}
      \end{equation}
    \item [Case $r \geq r'$ and $r < 0$.]
      \begin{equation}
        \begin{aligned}
          (a - b) - (a' - b') &\leq (a - b) - (ae^{-q} - be^{q}) \\
                              &\leq a^{\downarrow} - b^{\uparrow} - (a^{\downarrow}e^{-q} - a^{\uparrow}e^{q}) \\
                              &= a^{\downarrow}(1-e^{-q}) - b^{\uparrow}(1 - e^q)
        \end{aligned}
      \end{equation}
    \item [Case $r < r'$ and $r \geq 0$.]
      \begin{equation}
        \begin{aligned}
          (a' - b') - (a - b) &\leq ((ae^q - be^{-q}) - (a - b)) \\
                              &\leq ((a^{\uparrow}e^q - b^{\downarrow}e^{-q}) - (a^{\uparrow}- b^{\downarrow}))\\
                              &= a^{\uparrow}(e^{q}-1) - b^{\downarrow}(e^{-q} - 1)
        \end{aligned}
      \end{equation}
    \item [Case $r < r'$ and $r < 0$.]
      \begin{equation}
        \begin{aligned}
          (a' - b') - (a - b) &\leq ((ae^q - be^{-q}) - (a - b)) \\
                              &\leq ((a^{\downarrow}e^q - b^{\uparrow}e^{-q}) - (a^{\downarrow}- b^{\uparrow}))\\
                              &= a^{\downarrow}(e^{q}-1) - b^{\uparrow}(e^{-q} - 1)
        \end{aligned}
      \end{equation}
  \end{description}
  By taking the maximum of all possible cases, we can obtain a sound a priori
  absolute error bound.
\end{proof}

\begin{corollary}
  For $. \vdash e : M_q~\mathbf{num}_{(r^{\downarrow}, a^{\downarrow}, b^{\downarrow}), (r^{\uparrow}, a^{\uparrow}, b^{\uparrow})}$, 
  we know that $e \mapsto^{*} ((r, a, b), (r', a', b'))$ 
  where $|r - r'|$ is the maximum of the following:
\begin{enumerate}
  \item $a^{\uparrow}(1-e^{-q}) - b^{\downarrow}(1 - e^q)$
  \item $a^{\downarrow}(1-e^{-q}) - b^{\uparrow}(1 - e^q)$
  \item $a^{\uparrow}(e^{q}-1) - b^{\downarrow}(e^{-q} - 1)$
  \item $a^{\downarrow}(e^{q}-1) - b^{\uparrow}(e^{-q} - 1)$
\end{enumerate} 
\end{corollary} 
\begin{proof}
  By our logical relation and metric preservation theorem (Theorem
  \ref{thm:metric-preservation}), we know that $e \mapsto ((r, a, b), (r', a',
  b'))$ such that $d_{\mathbb{P}}((r, a, b), (r', a', b')) \leq q$. Therefore,
  $d_{\mathbb{R}}(a, a'), d_{\mathbb{R}}(b, b') \leq q$. Applying the previous
  theorem proves the corollary.
\end{proof}

% TODO: is there an a posterori absolute error theorem we can come up with?

