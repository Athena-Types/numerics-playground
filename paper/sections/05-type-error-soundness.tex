\section{Type Soundness}
\begin{lemma}[Termination]
  If $\Gamma \vDash e : \tau$, then $\forall \sigma$ compatible with $\Gamma$, 
  $$\sigma \Vdash e \rightsquigarrow^* \sigma' \Vdash v$$
\end{lemma}
\begin{proof}
  If $\sigma \Vdash e$ is a value, then we are done. Otherwise, if $\sigma
  \Vdash e$ is an expression, we begin by unfolding and applying the definition
  of $\vDash$. By definition, know that $\llbracket \sigma \Vdash e \rrbracket_{\tau} \in
  \llbracket \tau \rrbracket$. We also know that $\bot \not\in \llbracket \tau
  \rrbracket$, a metric space, so $\llbracket \sigma \Vdash e \rrbracket_{\tau}
  \not= \bot$ and is well-defined.

  By inspection of the definition of cases of $\llbracket - \rrbracket_{\tau}$,
  we know that only last case (which deals with all expressions) must apply.
  Therefore, $\sigma \Vdash e \rightsquigarrow^* \sigma' \Vdash v$.
\end{proof}

% \begin{theorem}[Semantic type preservation]
% If a term $e$ is semantically well-typed in context $\Gamma$ with type $\tau$
%   then for all $\sigma \Vdash e \rightsquigarrow \sigma' \Vdash e'$, $\sigma$
%   compatible with $\Gamma$, then there exists a $\Gamma'$ such that $\Gamma'
%   \vDash e' : \tau$.
% \end{theorem}
% \begin{proof}
% If $e$ is a value, we're done. 
% If $e$ is not a value, we proceed by induction over the cases of the rewrite relation
% $\rightsquigarrow$.
% % Our inductive hypothesis is that $e \rightsquigarrow e'$ and $\Gamma \vDash e : \tau$, that is, 
% % $\forall \sigma \text{ compatible with } \Gamma, \llbracket \sigma \Vdash e
% % \rrbracket_{\tau} \in \llbracket \tau \rrbracket$.
% \begin{description}
%   \item[\textsc{Variable lookup.}] If $$
%   \item[\textsc{Ret.}]
%   \item[\textsc{Rnd.}]
% \end{description}
% \end{proof}

% \begin{definition}[Monadic type]\label{def:monadic}
%   A type $\tau$ is monadic if and only if $\exists \tau', q \text{ such that }
%   \tau = M_q \tau'$. It is non-monadic otherwise.
% \end{definition}
% %%% wrong theorem:
% \begin{lemma}[Non-monadic lookup]\label{thm:non-monadic-lookup}
%   For all $\tau$ non-monadic and all $\Gamma, x : \tau'$ compatible with
%   $\sigma$, $\exists \sigma', \sigma = \sigma'[x \mapsto v : \tau']$ is
%   well-defined. Stated equivalently, non-monadic $x$ uniformly maps to $v$ at
%   all enviroments in $\sigma$.
% \end{lemma}
% \begin{proof}
%   TODO
% \end{proof}

\begin{lemma}[Enviroment tree shape]
  The tree height for a 
\end{lemma}

\begin{definition}[Orderings]
  We define the following well-founded partial order over configurations and
  types, which mirrors the definition of machine configuration interpretation
  and will be used for induction in the proceeding proofs.

  First, we define an ordering over types by size of the AST.
  \begin{equation}
    \begin{aligned}[c]
      s(\textbf{unit}) &= 1 \\
      s(\textbf{num}) &= 1 \\
      s(!_s \tau) &= s(\tau) + 1 \\
      s(M_q \tau) &= s(\tau) + 1 \\
      s(\tau_0 \times \tau_1) &= s(\tau_0) + s(\tau_1) + 1 \\
      s(\tau_0 \otimes \tau_1) &= s(\tau_0) + s(\tau_1) + 1 \\
      s(\tau_0 \multimap \tau_1) &= s(\tau_0) + s(\tau_1) + 1 \\
    \end{aligned}
  \end{equation}
  and
  \begin{equation}
    \tau_0 < \tau_0 \iff s(\tau_0) < s(\tau_1)
  \end{equation}

  Secondly, we define an ordering over environment leafs $\gamma$ using the number of bound
  variables:
  \begin{equation}
    \begin{aligned}[c]
      s(.) &= 0 \\
      s(\gamma, x \mapsto v :_s \tau) &= s(\gamma) + 1 \\
    \end{aligned}
  \end{equation}

  and

  \begin{equation}
    \gamma_0 < \gamma_0 \iff s(\gamma_0) < s(\gamma_1)
  \end{equation}

  We can now define an ordering over enviorment trees using the maximum size of
  each enviorment leaf in the tree:
  \begin{equation}
    \begin{aligned}[c]
      s(\gamma; \gamma') &= max(s(\gamma), s(\gamma')) \\
      s(\sigma; \sigma') &= max(s(\sigma), s(\sigma'))
    \end{aligned}
  \end{equation}

  We are now ready to define an ordering over $\textit{config} \times
  \textit{type}$:
  \footnote{Note that the type of the configuration (if the interpretation of
  the configuration belongs to the interpretation of the type) restricts the
  height and shape of environment tree. So we do not need to reason about the
  height of our enviroment trees in our ordering.}

  \begin{equation}
    \sigma \Vdash e : \tau < \sigma' \Vdash e' : \tau' \iff
    s(\tau) < s(\tau') \lor (s(\tau) = s(\tau') \land s(\sigma) < s(\sigma'))
  \end{equation}

\end{definition}

\begin{lemma}[Well-founded partial ordering]
  $\leq$ is a well-founded partial order over $\textit{config} \times
  \textit{type}$.
\end{lemma}
\begin{proof}
  TODO
\end{proof}

\begin{theorem}[Semantic type soundness]
$\Gamma \vdash e : \tau \implies \Gamma \vDash e : \tau$
\end{theorem}
\begin{proof}
From our premise, we wish to show that:
  \begin{enumerate}
    \item $\forall \sigma$ compatible with $\Gamma$, $\llbracket \sigma \Vdash e
      \rrbracket_{\tau} \in \llbracket \tau \rrbracket$.
    \item $\llbracket - \Vdash e
      \rrbracket_{\tau}$ is a \text{1-sensitive} map for all inputs enviroments
      compatible with $\Gamma$
  \end{enumerate}
We proceed by case analysis over whether $e$ is a value or an expression.
  Suppose $e$ is a value. We induct over the enviroment tree $\sigma$. Consider
  the enviroment leaf case, inducting over types and variables simulatenously in
  the enviroments using the following relative ordering: (1) height of the AST
  representing the type; and, (2) size of the enviroment (by number of bound
  variables).
\begin{description}
  \item[\textsc{Var.}] 
    % of $\Gamma$ in our typing rule. The base case is
    % vacuously true. There are two relevant cases to consider for the inductive
    % step: $\tau$ is either monadic or non-monadic (defined in
    % \ref{def:monadic}).
    \begin{description}
      \item[\textit{Non-monadic.}] By lemma~\ref{thm:non-monadic-lookup}, we
        have that there exists $\sigma'[x \mapsto v : \tau] = \sigma$.
      \item[\textit{Monadic.}]
    \end{description}
  \item[\textsc{Ret.}] 
    From our inductive hypothesis, we have that $\Gamma \vDash e : \tau$ and
    wish to prove that $\Gamma \vDash \mathbf{ret} \ e : \tau$. It suffices to
    show that $(\sigma; \sigma)[\alpha \mapsto v:_1 \tau] \Vdash \alpha$.
  \item[\textsc{Rnd.}]
\end{description}

  Next, the tree case:
\end{proof}

%%%% IGNORE BELOW %%%%

% todo: Use whatever theorem name people like best here.
Semantics is preserved under operational stepping. If $\sigma \Vdash e : \tau \rightsquigarrow \sigma'
\Vdash e' : \tau$, then $\llbracket \sigma \Vdash e : \tau \rrbracket =
\llbracket \sigma' \Vdash e' : \tau \rrbracket$.

% todo: Use whatever theorem name people like best here.
If the semantics of a program is equivalent to the semantics of a value, it must
reduce to that value. If $\llbracket \sigma \Vdash e : \tau \rrbracket =
\llbracket v : \tau \rrbracket$, then $\sigma \Vdash e : \tau
\rightsquigarrow^{*} \sigma' \Vdash v : \tau$

Syntactically well-typed programs are non-expansive. For $\Gamma \vdash e : \tau
$ and $\llbracket \sigma \rrbracket, \llbracket \sigma' \rrbracket \in
\llbracket \Gamma \rrbracket $ and
$$\sigma \Vdash e : \tau \rightsquigarrow^* v : \tau$$ 
and 
$$\sigma' \Vdash e : \tau \rightsquigarrow^* v' : \tau$$
then
$$
d_{\tau}(v, v') \leq d_{\Gamma}(\sigma, \sigma')
$$

Syntactically ok implies semantically ok. If $\Gamma \vdash e : \tau$, then
$\forall \llbracket \sigma \rrbracket \in \llbracket \Gamma \rrbracket, \exists
v, \llbracket \sigma \Vdash e : \tau \rrbracket = \llbracket v : \tau
\rrbracket$.

Syntactically ok implies operationally ok. If $\Gamma \vdash e : \tau$, then
$\forall \llbracket \sigma \rrbracket \in \llbracket \Gamma \rrbracket, \exists
v, \sigma \Vdash e : \tau \rightsquigarrow^{*} v : \tau$.

