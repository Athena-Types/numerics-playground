\section{Denotational Semantics}
\begin{definition}[Type interpretation]
  A type $\tau$ is interpreted with $\llbracket - \rrbracket : \textit{type} \to
  \textbf{Met}$ in the same way as in the original NumFuzz system.
  % TODO: put actual definition here.
\end{definition}

\begin{definition}[Context interpretation]
  A typing context $\Gamma$ is interpreted with $\llbracket - \rrbracket :
  \textit{context} \to \textbf{Met}$ in the following way:
  \begin{equation}
  \begin{aligned}[c]
    \llbracket . \rrbracket &\triangleq . \\
    \llbracket \Gamma, x : \tau \rrbracket &\triangleq \llbracket \Gamma \rrbracket
      \times \llbracket \tau \rrbracket
  \end{aligned}
  \end{equation}
\end{definition}

\begin{definition}[Machine configuration interpretation]
  A machine configuration $\sigma \Vdash e$ is interpreted with $\llbracket -
  \rrbracket_{ - } : \textit{config} \times \textit{type} \to \textit{point}$
  in the following way:
  \begin{equation}
  \begin{aligned}[c]
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%    Base cases (value and leaf)    %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \llbracket \gamma \Vdash \langle \rangle \rrbracket_{\textbf{unit}}
  &\triangleq * \\
  \llbracket \gamma [x \mapsto v] \Vdash x \rrbracket_{\tau}
  &\triangleq \llbracket \gamma \Vdash v \rrbracket_{\tau} \\
  \llbracket \gamma \Vdash \lambda x . e \rrbracket_{\tau_0 \multimap \tau_1}
  &\triangleq \{ (\llbracket \sigma \Vdash v \rrbracket_{\tau_0}, \llbracket \gamma +
  \sigma \Vdash (\lambda x . e) v \rrbracket_{\tau_1}) \> | \> \forall \sigma \Vdash v
  \in \textit{config}, \llbracket \sigma \Vdash v \rrbracket_{\tau_0} \not= \bot \} \\
  % todo: fill in more cases
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%             Tree case             %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % todo: check this, maybe encode internal choice somehow?
  \llbracket \sigma; \sigma' \Vdash e \rrbracket_{\tau} &\triangleq (\llbracket \sigma
  \Vdash e; \llbracket_{\tau} \sigma' \Vdash e \rrbracket_{\tau}) \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%             Expr case             %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \llbracket \sigma \Vdash e \rrbracket_{\tau} &\triangleq \llbracket \sigma'
  \Vdash v\rrbracket_{\tau} \quad{\text{ if } \sigma \Vdash e
  \rightsquigarrow^* \sigma' \Vdash v}
  \end{aligned}
  \end{equation}
  This is a well-founded relation with $\tau$ decreasing or $\tau$ constant and
  $\gamma$ decreasing in size.
\end{definition}

\begin{definition}[Environment compatibility]
  % Note: We can rewrite this defintion in a different style (without Coq-style
  % props) if that's easier to understand.
  Enviroment $\sigma$ is compatible with a typing context $\Gamma$ if and only
  if there exists a point $p \in \llbracket \Gamma \rrbracket$ such that:
  $$\sigma \textit{ \underline{com} } \Gamma \textit{ \underline{at} } p \textit{ \underline{in} } \llbracket \Gamma
  \rrbracket : \textit{env} \times \textit{ctx} \times \textit{point} \times
  \textbf{Met} \to \text{Prop}$$ 
  holds (read as $\sigma$ is compatible with $\Gamma$ at point $p$ in metric
  space $\llbracket \Gamma \rrbracket$), where:
  \begin{equation}
    \begin{aligned}[c] 
      % remove :s case
      \sigma \textit{ \underline{com} } \Gamma, x:_s \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times D_s (d_x, X) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times ((d_x, X)) \\
      % comonad case
      \sigma \textit{ \underline{com} } \Gamma, x: !_s \tau \textit{ \underline{at} } (\alpha, p) \textit{ \underline{in} } (d, Y) \times D_s ((d_x, X)) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times (d_x, X) \\
      % monad case
      \sigma; \sigma' \textit{ \underline{com} } \Gamma, x: M_r \tau \textit{ \underline{at} } (\alpha, (p, q)) \textit{ \underline{in} } (d, Y) \times T_r ((d_x, X)) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } (\alpha, p) \textit{ \underline{in} } (d, Y) \\
      & \text{ and } \sigma' \textit{ \underline{com} } \Gamma, x : \tau \text{ \underline{at} } (\alpha, q) \textit{ \underline{in} } (d, Y) \\
      & \text{ and } d_x (p, q) \leq r \\
      & \text{ and } p, q \in X \\
      % unit case
      \sigma[x \mapsto * : \tau] \textit{ \underline{com} } \Gamma, x: \textbf{unit} \textit{ \underline{at} } (\alpha, *) \textit{ \underline{in} } (d, X) \times (d_x, \{ * \}) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, X)\\
    \end{aligned}
  \end{equation}
\end{definition}
