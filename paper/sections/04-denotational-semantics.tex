\section{Denotational Semantics}
\begin{definition}[Type interpretation]
  A type $\tau$ is interpreted with $\llbracket - \rrbracket : \textit{type} \to
  \textbf{Met}$ in the same way as in the original NumFuzz system.
  % TODO: put actual definition here.
\end{definition}

\begin{definition}[Typing context interpretation]
  A typing context $\Gamma$ is interpreted with $\llbracket - \rrbracket :
  \textit{context} \to \textbf{Met}$ in the following way:
  \begin{equation}
  \begin{aligned}[c]
    \llbracket . \rrbracket &\triangleq . \\
    \llbracket \Gamma, x :_s \tau \rrbracket &\triangleq \llbracket \Gamma \rrbracket
      \times D_s \llbracket \tau \rrbracket
  \end{aligned}
  \end{equation}
\end{definition}

\begin{definition}[Machine configuration interpretation]
  A machine configuration $\sigma \Vdash e$ is interpreted with $\llbracket -
  \rrbracket_{ - } : \textit{config} \times \textit{type} \hookrightarrow
  \textit{point}$, a partial function, in the following way:
  \begin{equation}
  \begin{aligned}[c]
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%    Base cases (value and leaf)    %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \llbracket \gamma \Vdash \langle \rangle \rrbracket_{\textbf{unit}}
    &\triangleq * \\
  \llbracket \gamma \Vdash k \rrbracket_{\textbf{num}} &\triangleq k \\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%                                   %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \rule{5em}{0.4pt}&\rule{30em}{0.4pt}\\
  \llbracket \gamma [x \mapsto v] \Vdash x \rrbracket_{\tau} &\triangleq
    \llbracket \gamma \Vdash v \rrbracket_{\tau} \\
  \llbracket \gamma \Vdash (v, w) \rrbracket_{\tau_0 \otimes \tau_1} &\triangleq
    (\llbracket \gamma \Vdash v \rrbracket_{\tau_0}, \llbracket \gamma \Vdash v
    \rrbracket_{\tau_1}) \\
  \llbracket \gamma \Vdash \lambda x . e \rrbracket_{\tau_0 \multimap \tau_1}
    &\triangleq \{ (\llbracket \sigma \Vdash v \rrbracket_{\tau_0}, \llbracket
    \gamma + \sigma \Vdash (\lambda x . e) v \rrbracket_{\tau_1}) \> | \>
    \forall \sigma \Vdash v \in \textit{config}, \llbracket \sigma \Vdash v
    \rrbracket_{\tau_0} \not= \bot \} \\
  \llbracket \gamma \Vdash v \rrbracket_{!_s \tau} &\triangleq \llbracket \gamma
    \Vdash v \rrbracket_\tau \\
  % todo: fill in more cases
  \rule{5em}{0.4pt}&\rule{30em}{0.4pt}\\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%            Tree cases             %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % todo: check this, maybe encode internal choice somehow?
  \llbracket \sigma; \sigma' \Vdash v \rrbracket_{\tau_0 \times \tau_1}
    &\triangleq (\llbracket \sigma \Vdash v \rrbracket_{\tau_0}, \llbracket
    \sigma' \Vdash v \rrbracket_{\tau_1}) \\
  \llbracket \sigma_0; \sigma_1 \Vdash \mathbf{in_i} \ x \rrbracket_{\tau}
    &\triangleq \llbracket \sigma_i \Vdash x \rrbracket_{\tau} \\
  \llbracket \sigma; \sigma' \Vdash v \rrbracket_{M_q \tau} &\triangleq
    (\llbracket \sigma \Vdash v \rrbracket_{\tau}, \llbracket \sigma' \Vdash v
    \rrbracket_{\tau}) \\
  \rule{5em}{0.4pt}&\rule{30em}{0.4pt}\\
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%            Expr case              %%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \llbracket \sigma \Vdash e \rrbracket_{\tau} &\triangleq \llbracket \sigma'
    \Vdash v\rrbracket_{\tau} \quad{\text{ if } \sigma \Vdash e
    \rightsquigarrow^* \sigma' \Vdash v}
  \end{aligned}
  \end{equation}
  This is a well-founded relation defined first on values and enviroment leafs,
  with $\tau$ decreasing or $\tau$ constant and $\gamma$ decreasing in size. It
  is then defined on enviroment trees and then on expressions that are not
  values, if it can be rewritten to a value.
\end{definition}

\begin{definition}[Environment compatibility]
  % Note: We can rewrite this defintion in a different style (without Coq-style
  % props) if that's easier to understand.
  Enviroment $\sigma$ is compatible with a typing context $\Gamma$ if and only
  if there exists a point $p \in \llbracket \Gamma \rrbracket$ such that:
  $$\sigma \textit{ \underline{com} } \Gamma \textit{ \underline{at} } p
  \textit{ \underline{in} } \llbracket \Gamma \rrbracket $$
  holds (read as $\sigma$ is compatible with $\Gamma$ at point $p$ in metric
  space $\llbracket \Gamma \rrbracket$), which has type:
  $$- \textit{ \underline{com} } - \textit{ \underline{at} } -
  \textit{ \underline{in} } - : \textit{env} \times
  \textit{ctx} \times \textit{point} \times \textbf{Met} \to \text{Prop}$$ 
  The definition is as follows:
  \begin{equation}
    \begin{aligned}[c] 
      % remove :s case
      \sigma \textit{ \underline{com} } \Gamma, x:_s \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times D_s (d_x, X) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times ((d_x, X)) \\
      % comonad case
      \sigma \textit{ \underline{com} } \Gamma, x: !_s \tau \textit{ \underline{at} } (\alpha, p) \textit{ \underline{in} } (d, Y) \times D_s ((d_x, X)) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, Y) \times (d_x, X) \\
      % monad case
      \sigma; \sigma' \textit{ \underline{com} } \Gamma, x: M_r \tau \textit{ \underline{at} } (\alpha, (p, q)) \textit{ \underline{in} } (d, Y) \times T_r ((d_x, X)) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma, x : \tau \textit{ \underline{at} } (\alpha, p) \textit{ \underline{in} } (d, Y) \times (d_x, X) \\
      & \text{ and } \sigma' \textit{ \underline{com} } \Gamma, x : \tau \text{ \underline{at} } (\alpha, q) \textit{ \underline{in} } (d, Y) \times (d_x, X) \\
      & \text{ and } d_x (p, q) \leq r \\
      & \text{ and } p, q \in X \\
      % unit case
      \sigma[x \mapsto * : \tau] \textit{ \underline{com} } \Gamma, x: \textbf{unit} \textit{ \underline{at} } (\alpha, *) \textit{ \underline{in} } (d, X) \times (d_x, \{ * \}) &\triangleq 
      \sigma \textit{ \underline{com} } \Gamma \textit{ \underline{at} } \alpha \textit{ \underline{in} } (d, X)\\
      % function case
      \sigma[x \mapsto \lambda y . e] \textit{ \underline{com} } \Gamma, x :
      \tau_0 \multimap \tau_1 \textit{ \underline{at} } (\alpha, f) \textit{
        \underline{in} } (d, Y) \times (d_x, X) &\triangleq \sigma \textit{
        \underline{com} } \Gamma \textit{ \underline{at} } \alpha \textit{
        \underline{in} } (d, Y) \\
      & \text{ and } \llbracket \sigma \Vdash \lambda y . e \rrbracket_{\tau_0
      \multimap \tau_1} \subseteq f \\
      & \text{ and } f \in X \text{ and 1-sensitive} \\
      % var case
      \sigma[x \mapsto y] \textit{ \underline{com} } \Gamma, x :
      \tau \textit{ \underline{at} } \alpha \textit{
        \underline{in} } (d, Y) &\triangleq \sigma \textit{
        \underline{com} } \Gamma \textit{ \underline{at} } \alpha \textit{
        \underline{in} } (d, Y) \\
    \end{aligned}
  \end{equation}
\end{definition}


\begin{definition}[Semantic well-typedness]
  An expression $e$ is semantically well-typed in a context $\Gamma$ at type
  $\tau$, written:
  $$\Gamma \vDash e : \tau$$
  if and only if for all $\sigma$ compatible with $\Gamma$, $\llbracket \sigma
  \Vdash e \rrbracket_{\tau} \in \llbracket \tau \rrbracket$.
\end{definition}

